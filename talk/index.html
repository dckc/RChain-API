<html>
  <head>
    <title>RChain-API: a node.js package for RChain</title>
    <meta charset="utf-8" />
    <meta name="viewport"
	  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link rel="stylesheet" href="reveal.js/css/reveal.css" />
    <!-- ISSUE: text-transform: uppercase; around line 57 (heading?) -->
    <link rel="stylesheet" href="reveal.js/css/theme/sky.css" />
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css" />
    <style>
      .boxed {
          border-radius: 10px !important;
      border: 3px solid black !important;
      }
      .math-display {
      font-size: large !important;
      }

      table {
    margin: 10px !important;
    border-collapse: separate !important;
    border-spacing: 40px !important;
}
    </style>
<script>
	var link = document.createElement( 'link' );
	link.rel = 'stylesheet';
	link.type = 'text/css';
	link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
	document.getElementsByTagName( 'head' )[0].appendChild( link );
</script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
	<section>
	  <h2>RChain-API: a <b>node.js</b> package for RChain</h2>
	  <p>by Dan Connolly, Josh Orndorff, and other contributors</p>
	  <p>Aug 2018</p>
	</section>
	<section>
	  <h2>Origin: Trust Metric in Rholang</h2>
	  <img src="https://www.diigo.com/file/image/brpqocpzeppprraqezdodddoob/Port+Trust+Metric+to+Rholang+%C2%B7+Issue+%23561+%C2%B7+rchain%2Fbounties.jpg" alt="Port Trust Metric to Rholang #561" />
	</section>
<section data-markdown="">
## Step 1: Trust Certifications on RChain

First part of trust metric protocol:

> I (dckc) certify Bob at journeyer level.
</section>
<section data-markdown="">
## Web UI makes JSON data

> I (dckc) certify Bob at journeyer level.

becomes

```{javascript}
{
  "voter": "dckc",
  "subject": "bob",
  "rating": 2,
  "cert_time": "2018-07-29T02:00:21.259Z"
}
```
</section>

<section data-markdown="">
## How to do transactions?

The [Genesis Block Demo][gbd] of July 11 showed all the pieces working
together:

  - Signatures are generated offline
  - on-chain contract, [BasicWallet.rho][bw], checks signatures

```
@cryptoVerify!([nonce, amount, retCh].toByteArray(),
               sig.hexToBytes(), pk.hexToBytes(), *result)
```

[bw]: https://github.com/rchain/rchain/blob/dev/casper/src/main/rholang/BasicWallet.rho
[gbd]: https://www.youtube.com/watch?v=WzAdfjwgaQs#t=9m28s
</section>

<section>
<h2>What bytes to sign?</h2>

<pre><code class="hljs" data-trim="">
@cryptoVerify!(<b style="text-decoration: underline">[nonce, amount, retCh].toByteArray()</b>,
               sig.hexToBytes(), pk.hexToBytes(), *result)
</code></pre>
</section>
<section data-markdown="">
## How to serialize Rholang data?

  - RChain nodes communicate [CasperMessage.proto][cp]
    - a gRPC protocol
    - uses protobuf serialization
  - [CasperMessage.proto][cp] uses datatypes from [RhoTypes.proto][rt]

[rt]: https://github.com/rchain/rchain/blob/dev/models/src/main/protobuf/RhoTypes.proto
[cp]: https://github.com/rchain/rchain/blob/dev/models/src/main/protobuf/CasperMessage.proto
</section>

<section data-markdown="">
## How to turn JSON into RhoTypes?

```{javascript}
{ "voter": "dckc",
  "subject": "bob",
  "rating": 2,
  "cert_time": "2018-07-29T02:00:21.259Z" }
```

_[Mobile process calculi for the blockchain][1]_:
> ... we can detail a **direct representation of JSON into a
> fragment of the rholang syntax** referred to ...
> as RHOCore.

[1]: https://github.com/rchain/mobile-process-calculi-for-blockchain/blob/master/enter-the-blockchain.rst
</section>

	<section>
	  <h2>JSON and Rholang</h2>
	  <table><tbody>
	    <tr>
	  <td class="math-display boxed">
	    \[
	    \begin{array}{lll}
	  Obj & ::= & \{\ Key : Val\ [,\ Key : Val\ ] \} \\
	  Key & ::= & "\ [Char]+\ " \\
	  Val & ::= & Grnd\ |\ Arry\ |\ Obj \\
	  Grnd & ::= & Bool\ |\ Num\ |\ Str\ |\ ... \\
	  Arry & ::= & [\ Obj\ [,Obj]\ ]
	    \end{array}
	  \]
	  </td>
	  <td class="math-display boxed">
	  \[\begin{array}{lll}
	  P & ::= & \{\ [P\ [|\ P]]\ \} \\
	  & | & {\tt for(} Ptrn\ \texttt{ <-}\ X\ [{\tt ;}\ Ptrn \texttt{ <-}\ X]\ {\tt })\ P \\
          & | & X {\tt !(}\ P\ {\tt )} \\
          & | & {\tt *} X \\
          & | & V \\
	  V & ::= & Arry\ |\ Grnd\ \\
	  Grnd & ::= & Bool\ |\ Num\ |\ Str\ |\ ... \\
          Ptrn & ::= & X\ |\ \_\ |\ ... \\
          X & ::= & @P\ |\ [Char]+ \\
          \end{array}
          \]
									     </td>
	    </tr></tbody>
	  </table>
	  <div class="math-display">
	  \[\begin{equation}
	  [\![\{ key_1 : val_1,\ ... ,\ key_N : val_N \}]\!] = 
	  \{ [\![key_1]\!]!(\ [\![val_1]\!]\ )\ |\ ...\ |\ [\![key_N]\!]!(\ [\![val_N]\!]\ )\ \}
	  \end{equation}\]
	  </div>
	  <p>Embeds JSON into RHOCore</p>
	</section>
<section>
<h2>RhoTypes.proto</h2>

<p>A process (<code>Par</code>) has <code>Expr</code>s, <code>Send</code>s, ...:</p>

<table><tr><td>
<pre><code class="hljs" data-trim>
message Par {
    repeated Send sends = 1;
    repeated Receive receives = 2;
    repeated New news = 4;
    repeated Expr exprs = 5;
...
</code></pre>
</td>
	  <td class="math-display boxed">
	  \[\begin{array}{lll}
	  P & ::= & \{\ [P\ [|\ P]]\ \} \\
	  & | & {\tt for(} Ptrn\ \texttt{ <-}\ X\ [{\tt ;}\ Ptrn \texttt{ <-}\ X]\ {\tt })\ P \\
          & | & X {\tt !(}\ P\ {\tt )} \\
          & | & {\tt *} X \\
          & | & V \\
	  V & ::= & Arry\ |\ Grnd\ \\
	  Grnd & ::= & Bool\ |\ Num\ |\ Str\ |\ ... \\
          Ptrn & ::= & X\ |\ \_\ |\ ... \\
          X & ::= & @P\ |\ [Char]+ \\
          \end{array}
          \]
</td></tr></table>
</section>
      	<section>
	  <h2>JSON to RHOCore</h2>
	  <table><tbody>
	    <tr>
	  <td class="math-display boxed">
	    \[
	    \begin{array}{lll}
	  Obj & ::= & \{\ Key : Val\ [,\ Key : Val\ ] \} \\
	  Key & ::= & "\ [Char]+\ " \\
	  Val & ::= & Grnd\ |\ Arry\ |\ Obj \\
	  Grnd & ::= & Bool\ |\ Num\ |\ Str\ |\ ... \\
	  Arry & ::= & [\ Obj\ [,Obj]\ ]
	    \end{array}
	  \]
	  </td>
	  <td>
          <pre><code class="hljs" data-trim>
function toRSON(val) {
    const expr1 = kv => { exprs: [kv] };
    function toArry(items) {
        return expr1({e_list_body: { ps: items.map(recur) } });
    }
    function keysValues(obj) {
    function recur(x) { ... }

    return recur(val);
}
          </code></div>
	  <p><small><em>TODO: fix the "RSON" misnomer</em></small></p>
          </td></tr></tbody></table>
	</section>
	<section>
	  <h2>JSON to RHOCore: Objects become Sends</h2>
	  <pre><code class="hljs" data-trim>
    function keysValues(obj) {
        const sends = Object.keys(obj).sort().map(k => {
            const chan = { quote: expr1({ g_string: k }) };
            return fixLF({ chan: chan, data: [recur(obj[k])] });
        });
        return fixLF({ sends });
    }
	  </code></pre>
	  <div class="math-display">
	  \[\begin{equation}
	  [\![\{ key_1 : val_1,\ ... ,\ key_N : val_N \}]\!] = 
	  \{ [\![key_1]\!]!(\ [\![val_1]\!]\ )\ |\ ...\ |\ [\![key_N]\!]!(\ [\![val_N]\!]\ )\ \}
	  \end{equation}\]
	  </div>
<p><small><strong>Don't forget to <code>sort()</code>!</strong><br />You won't get the right bytes to sign.</small></p>
	</section>
	<section>
	  <h2>JSON to RHOCore: recur</h2>
	  <pre class="stretch"><code class="hljs" data-trim contenteditable>
    function recur(x) {
        switch (typeof x) {
        case 'boolean':
            return expr1({ g_bool: x });
        case 'number':
            return expr1({ g_int: x }); // ISSUE: only integers
        case 'string':
            return expr1({ g_string: x });
        case 'object':
            if (x === null) {
                return fixLF({});
            } else if (Array.isArray(x)) {
                return toArry(x);
            } else {
                return keysValues(x);
            }
        default:
            throw(new Error('no mapping to RSON for ' +  typeof x));
        };
    }
	  </code></pre>
	</section>
	<section>
	  <h2>JSON to RHOCore*</h2>
	  <p>This locallyFree: emptyBitSet stuff shouldn't be necessary; see
	    <a href="https://rchain.atlassian.net/browse/RHOL-537">RHOL-537</a>.</p>
	  <pre><code class="hljs" data-trim>
const bytesPerLong = 8;
const emptyBitSet = new Buffer(Array(bytesPerLong).fill(0));
function toRSON(x) {
    const fixLF = p => Object.assign({ locallyFree: emptyBitSet }, p);

    const expr1 = kv => fixLF({ exprs: [kv] });
	  </code></pre>
	</section>

<section><h2>Back to our Trust Metric dApp...</h2>
</section>

<section><h2><code>gameSession.gs</code>:<br />OAuth Gateway</h2>
  <dl>
    <dt>Policy:</dt><dd>Only RChain cooperative members are authorized.</dd>
    <dt>Mechanism:</dt><dd>discord <b>member</b> role via OAuth2 API</dd>
  </dl>
</section>

<section><h2><code>gameSession.gs</code>:<br />OAuth Gateway</h2>
  <div>... discord <b>member</b> role via OAuth2 API:</div>
  <ul>
    <li>Smart contracts are like multiplayer games.</li>
    <li>The gateway hosts games,<br />each with its own key pair.</li>
    <li>An OAuth session becomes<br /> participation in a game.
    <li>The gateway signs moves on behalf of players.</li>
  </ul>
</section>
<section>
<h2>OAuth2 leads to JavaScript</h2>

<dl>
  <dt>scala:</dt><dd>OAuth2 libraries are not mature</dd>
  <dt>JavaScript:</dt><dd>
    <a href="https://medium.com/@orels1/using-discord-oauth2-a-simple-guide-and-an-example-nodejs-app-71a9e032770">simple guide to discord oauth2</a> May 2017 by Orlov</dd>
</dl>
</section>
<section>
  <h2>Off-chain ocap security and persistence: Capper</h2>
  <p><a href="https://github.com/dckc/Capper">Capper</a>:</p>
  <ul>
    <li>ocaps for node.js and express</li>
    <li>object persistence</li>
    <li><a href="http://waterken.sourceforge.net/web-key/">waterken webkeys</a></li>
  </ul>
  <p><small><em>a story for another day...</em></small></p>
</section>
<section>
  <h2><code>gameSession.js</code>:<br />off-chain signature</h2>
  <pre><code class="hljs" data-trim>
    const gatewayKey = ... ;
    const cert1 = { voter: "dckc", subject: "bob", rating: 2, cert_time: clock().toISOString() };

    const certPar = RSON.fromData(cert1),
          certSigHex = gatewayKey.signBytesHex(rchain.toByteArray(certPar))
          certRho = RSON.stringify(certPar),
          sigRho = JSON.stringify(certSigHex)
          certTerm = `@"takeTurn"!(${certRho}, ${sigRho})`;

    const rchain = rnodeAPI.clientFactory({grpc, clock})
	      .casperClient({ host, port });
    rchain.doDeploy(certTerm).then(result => {
	if (!result.success) { throw(result); }
	return rchain.createBlock();
  </code></pre>
</section>

<section>
  <h2><code>gameSession.js</code>:<br />off-chain signature</h2>
  <p>using <code>tweetnacl</code>:</p>
  <pre><code class="hljs scala" data-trim>
@"takeTurn"!("850a6d00e44e5dd9ec02d05bda38d7da760c9c143f2499a754d66dc43f0177df",
    ["merge", "trust_cert",
     @"cert_time"!("2018-08-10T20:31:46.545Z") |
     @"rating"!("1") | @"subject"!("c3") | @"voter"!("dckc")
], <b style="text-decoration: underline">"182e4fea4f9a53ed99cf4560d2254c476d64fafefd1e19ccb9a34e71cc0ba12592d58b7c096731a2d189e5097f467ebdf062d752815a87281e4b59f7174ca00a"</b>, *ret)
  </code></pre>
</section>

<section>
  <h2><code>communityTrust.rho</code>:<br /> on-chain verification</h2>
  <pre><code class="hljs" data-trim>
  contract @"takeTurn"(@gameKey, @turn, @turnSig, return) = {
    new sigCh in {
      @"ed25519Verify"!(turn.toByteArray(),
                        turnSig.hexToBytes(), gameKey.hexToBytes(), *sigCh))
      ...
</code></pre></section>

<section><h2>MySql to RChain</h2>
  <p><small>Another in-progress application of this rchain-api package:</small></p>
  <ul>
    <li>Use the DB to enforce business logic constraints.</li>
    <li>Subscribe to valid changes and send them to RChain.</li>
    <li><em>Subscribe to RChain and update the DB?</em></li>
  </ul>
</section>

<section><h2>MySql events binlog</h2>
  <ul>
    <li>Originally for replication</li>
    <li>Available to node.js via <code>mysql-events</code> npm package</li>
  </ul>
</section>

<section><h2>MySql event data</h2>

  <pre><code class="hljs" data-trim>
{ type: 'INSERT', table: 'budget_vote',
  rows: [ { after: { pay_period: 2018-07-01T05:00:00.000Z,
                     issue_num: 199, voter: 'dckc', amount: 425,
                     vote_time: 2018-08-05T01:19:05.000Z, weight: null },
            before: undefined } ]
  </code></pre>
</section>

<section><h2>Rholang Translation of SQL data</h2>
  <pre><code class="hljs scala" data-trim>
@[`https://rewards.rchain.coop`, "budget_vote"]
      !("INSERT", [@"after"!(@"amount"!(425) | @"issue_num"!(199) | @"pay_period"!("2018-07-01T05:00:00.000Z") | @"vote_time"!("2018-08-05T01:19:05.000Z") | @"voter"!("dckc") | @"weight"!(Nil))])
  </code></pre>
</section>

<section><h2>INSERT SQL data to to RChain</h2>
  <p>in rnode log:</p>

  <pre><code class="hljs plain" data-trim>
20:19:05.205 [grpc-default-executor-1] INFO  c.rchain.casper.MultiParentCasper$ - CASPER: Received Deploy #1533431945199 -- @{[``https://rewards.rcha...
  </code></pre>
</section>

</div>
    </div>
    <script src="reveal.js/lib/js/head.min.js"></script>
    <script src="reveal.js/js/reveal.js"></script>
    <script>
      Reveal.initialize({
      history: true,
      transition: 'fade',
        dependencies: [
        // Cross-browser shim that fully implements classList - https://github.com/eligrey/classList.js/
        { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },

        // Interpret Markdown in <section> elements
        { src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
	{ src: './reveal.js/plugin/externalcode/externalcode.js', condition: function() { return !!document.querySelector( '[data-code]' ); } },
        // Syntax highlight for <code> elements
        { src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },

        // Zoom in and out with Alt+click
        { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },

        // Speaker notes
        { src: 'reveal.js/plugin/notes/notes.js', async: true },

        // MathJax
        { src: 'reveal.js/plugin/math/math.js', async: true }
       ]
     });
    </script>
  </body>
</html>
